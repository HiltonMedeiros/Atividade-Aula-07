name: Python CI/Security Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  build-and-sast:

    name: Build & SAST (Bandit)
    runs-on: ubuntu-latest

    # Define os passos (steps) do trabalho
    steps:
      # 1.Baixar o seu código
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2 Configurar o Python 3.8
      - name: Set up Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      # 3.Instalar as dependências
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8
          pip install bandit  # <-- NOVO! (Instala o SAST)
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 4.Rodar o "corretor" (linter)
      - name: Lint with flake8
        run: |
          flake8 . --count --show-source --statistics

      # 5.Rodar o SAST (Bandit)
      - name: Run SAST with Bandit # <-- NOVO!
        run: |
          bandit -r . -f "txt"
          # O comando '-r .' significa "escaneie recursivamente este diretório"

  # --------------------------------------------------------------------
  # DAST
  # --------------------------------------------------------------------
  dast-scan:

    name: DAST Scan (OWASP ZAP)
    runs-on: ubuntu-latest

    # Este "job" só roda DEPOIS que o 'build-and-sast' terminar com sucesso
    needs: build-and-sast # <-- NOVO!

    steps:
      # 1.Baixar o seu código
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2.Configurar o Python 3.8
      - name: Set up Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      # 3.Instalar as dependências do seu app (ex: Flask, FastAPI, etc.)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 4.Iniciar sua aplicação em segundo plano
      - name: Start application
        run: |
          # --- ATENÇÃO AQUI! ---
          # Este é um EXEMPLO. Você DEVE ajustar este comando
          # para o comando que inicia o SEU app (Flask, FastAPI, etc.)
          # O '&' no final faz o app rodar em segundo plano (background).
          
          python app.py &
          
          # Espera 10 segundos para o servidor subir
          sleep 10

      # 5.Rodar o DAST Scan
      - name: OWASP ZAP Baseline Scan
        uses: OWASP/zap-scan@v0.1.0
        with:
        target: 'http://localhost:8080'